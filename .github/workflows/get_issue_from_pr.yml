name: Resuable workflow to get an issue from a PR
on:
  workflow_call:
    inputs:
      org:
        required: true
        type: string
      repo:
        required: true
        type: string
      pr_id:
        required: true
        type: string     
    secrets:
      GHPROJECT_TOKEN:
        required: true
    outputs:
      issue_from_pr:
        description: "The issue that the PR relates to"
        value: ${{ jobs.get_issue_from_pr.outputs.job_issue_id }}

jobs:
  get_issue_from_pr:
    name: Get issue from PR
    runs-on: ubuntu-latest
    # Map the job outputs to step outputs
    outputs:
      job_issue_id: ${{ steps.get_issue.outputs.step_issue_id }}
    steps:
      - id: get_issue
        env:
          GITHUB_TOKEN: ${{ secrets.GHPROJECT_TOKEN }}
          ORGANIZATION: ${{ inputs.org }}
          REPO: ${{ inputs.repo }}
        run: |
          gh api graphql -f query='
            query($org: String!, $repo: String!){
              repository(owner: $org, name: $repo) {
                pullRequest(number: ${{ inputs.pr_id }}) {
                  closingIssuesReferences(first: 1) {
                    edges {
                      node {
                        id
                      }
                    }
                  }
                }
              }
            }' -f org=$ORGANIZATION -F repo=$REPO > project_data.json

          echo "$(<project_data.json )"
          echo 'step_issue_id='$(jq '.data.repository.pullRequest.closingIssuesReferences.edges[0].node.id' project_data.json) >> $GITHUB_OUTPUT